<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>東京旅プール財布 - 履歴付き</title>
  <style>
    body {
      font-family: "Helvetica Neue", sans-serif;
      background: #f9f9f9;
      padding: 1em;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: white;
      border-radius: 12px;
      padding: 1em;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #4A90E2;
    }
    label, input, select, button {
      display: block;
      width: 100%;
      margin-bottom: 0.7em;
    }
    button {
      background: #4A90E2;
      color: white;
      border: none;
      padding: 0.7em;
      font-size: 1em;
      border-radius: 8px;
    }
    .log {
      margin-top: 1em;
      font-size: 0.9em;
      color: #555;
    }
    .balance {
      margin-top: 1em;
      font-weight: bold;
      font-size: 1.1em;
      color: #00796b;
    }
    .history {
      margin-top: 2em;
    }
    .history h3 {
      margin-bottom: 0.5em;
      font-size: 1.1em;
    }
    .history ul {
      list-style: none;
      padding: 0;
    }
    .history li {
      padding: 0.3em 0;
      border-bottom: 1px solid #eee;
      font-size: 0.95em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>東京旅プール財布</h1>
    <div id="balance" class="balance">残額を取得中...</div>

    <label>項目: <input id="desc" type="text" /></label>
    <label>金額: <input id="amount" type="number" /></label>
    <label>立替者:
      <select id="payer">
        <option value="">プールから直接</option>
        <option value="玄位">玄位</option>
        <option value="浩史">浩史</option>
        <option value="晶子">晶子</option>
        <option value="献四郎">献四郎</option>
        <option value="真理子">真理子</option>
        <option value="和貴">和貴</option>
        <option value="優貴子">優貴子</option>
      </select>
    </label>
    <button onclick="sendData()">スプレッドシートに登録</button>
    <div class="log" id="log"></div>

    <div class="history" id="history"></div>
  </div>

  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbyybVoER8k4ZsE18ofSKrxAmrL6BKEUzk4ViC2QEdTAAEaqXqMV8w0GN5ydzotwMOglnA/exec";

    function fetchData() {
      fetch(endpoint)
        .then(res => res.json())
        .then(data => {
          document.getElementById("balance").innerText =
            `現在の残額：${data.balance.toLocaleString()}円`;

          const historyDiv = document.getElementById("history");
          historyDiv.innerHTML = "<h3>支払い履歴</h3><ul>" +
            data.entries.reverse().map(e =>
              `<li>${e.date}｜${e.desc}｜${e.amount.toLocaleString()}円｜${e.payer}</li>`
            ).join("") +
            "</ul>";
        })
        .catch(() => {
          document.getElementById("balance").innerText = "データ取得に失敗しました";
        });
    }

    function sendData() {
      const desc = document.getElementById("desc").value;
      const amount = document.getElementById("amount").value;
      const payer = document.getElementById("payer").value;

      if (!desc || !amount) {
        alert("項目と金額を入力してください");
        return;
      }

      fetch(endpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ desc, amount, payer })
      })
      .then(res => res.text())
      .then(txt => {
        alert("送信結果: " + txt);
        fetchData();
      })
      .catch(err => {
        alert("送信失敗: " + err.message);
      });

      document.getElementById("log").innerText =
        "登録しました（反映に数秒かかります）";
      document.getElementById("desc").value = "";
      document.getElementById("amount").value = "";
    }

    fetchData();
  </script>
</body>
</html>
